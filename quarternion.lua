-- title:  Quarternion
-- author: pke1029
-- desc:   Quarternion rotation with tic80
-- script: lua

-- center of scene
center = {0, 0, 300}

-- distance to screen (depth)
d = 180
-- center of rotation
pivot = {0, 0, 0}
angle = 0
ax = {1, 0, 0}
ay = {0, 1, 0}
points = {}

sqrt = math.sqrt
cos = math.cos
sin = math.sin
abs = math.abs
floor = math.floor

function norm(v)
	return sqrt(v[1]*v[1] + v[2]*v[2] + v[3]*v[3])
end

function normalise(v)
	local r = norm(v)
	return scale(1/r, v)
end

function add(u, v)
	return {u[1]+v[1], u[2]+v[2], u[3]+v[3]}
end

function scale(k, v)
	return {k*v[1], k*v[2], k*v[3]}
end

function cross(u, v)
	return {u[2]*v[3]-v[2]*u[3], v[1]*u[3]-u[1]*v[3], u[1]*v[2]-v[1]*u[2]}
end

function dot(u, v)
	return u[1]*v[1] + u[2]*v[2] + u[3]*v[3]
end

function rotateQuarternion(p3d, pivot, axis, angle)
	local v = add(p3d.v, scale(-1, pivot))
	local c = cos(angle/2)
	local s = sin(angle/2)
	local u = scale(s, axis)

	local k = dot(u, v)
	local w = cross(u, v)

	p3d.v = add(add(add(scale(2*k, u), scale(c*c-s*s, v)), scale(2*c, w)), pivot)
end

function createCube()
	points = {}
	local l = 10
	local p 
	for x = -3,3 do
		for y = -3,3 do
			for z = -3,3 do
				p = {
					v = scale(l, {x, y, z}),
					c = abs(x+y+z)
				}
				table.insert(points, p)
			end
		end
	end
end

function p2d(p3d)
	local v0 = add(p3d.v, center) 
	local x2d = d * v0[1] / v0[3]
	local y2d = d * v0[2] / v0[3]
	
	return x2d, y2d
end

function zsort(p1, p2)
	return p1.v[3] > p2.v[3]
end

function TIC()
	
	cls(10)

	-- createCube()
	createTeapot()

	for k,p in pairs(points) do
		rotateQuarternion(p, {0, 0, 0}, normalise({0, 0, 1}), 0.7)
		rotateQuarternion(p, pivot, {0, 1, 0}, angle)
	end

	table.sort(points, zsort)

	for k,p in pairs(points) do
		i, j = p2d(p)
		rect(i + 120, j + 68, 6, 6, p.c)
	end

	angle = angle + 0.05
end

function createTeapot()
	points = {
		{v={ 1.4000,-0.9000, 0.0000},c=0},
		{v={ 1.4000,-0.9000,-0.7840},c=0},
		{v={ 0.7800,-0.9000,-1.4000},c=0},
		{v={ 0.0000,-0.9000,-1.4000},c=0},
		{v={ 1.3375,-1.0312, 0.0000},c=0},
		{v={ 1.3375,-1.0312,-0.7490},c=0},
		{v={ 0.7490,-1.0312,-1.3375},c=0},
		{v={ 0.0000,-1.0312,-1.3375},c=0},
		{v={ 1.4375,-1.0312, 0.0000},c=0},
		{v={ 1.4375,-1.0312,-0.8050},c=0},
		{v={ 0.8050,-1.0312,-1.4375},c=0},
		{v={ 0.0000,-1.0312,-1.4375},c=0},
		{v={ 1.5000,-0.9000, 0.0000},c=0},
		{v={ 1.5000,-0.9000,-0.8400},c=0},
		{v={ 0.8400,-0.9000,-1.5000},c=0},
		{v={ 0.0000,-0.9000,-1.5000},c=0},
		{v={-0.7840,-0.9000,-1.4000},c=0},
		{v={-1.4000,-0.9000,-0.7840},c=0},
		{v={-1.4000,-0.9000, 0.0000},c=0},
		{v={-0.7490,-1.0312,-1.3375},c=0},
		{v={-1.3375,-1.0312,-0.7490},c=0},
		{v={-1.3375,-1.0312, 0.0000},c=0},
		{v={-0.8050,-1.0312,-1.4375},c=0},
		{v={-1.4375,-1.0312,-0.8050},c=0},
		{v={-1.4375,-1.0312, 0.0000},c=0},
		{v={-0.8400,-0.9000,-1.5000},c=0},
		{v={-1.5000,-0.9000,-0.8400},c=0},
		{v={-1.5000,-0.9000, 0.0000},c=0},
		{v={-1.4000,-0.9000, 0.7840},c=0},
		{v={-0.7840,-0.9000, 1.4000},c=0},
		{v={ 0.0000,-0.9000, 1.4000},c=0},
		{v={-1.3375,-1.0312, 0.7490},c=0},
		{v={-0.7490,-1.0312, 1.3375},c=0},
		{v={ 0.0000,-1.0312, 1.3375},c=0},
		{v={-1.4375,-1.0312, 0.8050},c=0},
		{v={-0.8050,-1.0312, 1.4375},c=0},
		{v={ 0.0000,-1.0312, 1.4375},c=0},
		{v={-1.5000,-0.9000, 0.8400},c=0},
		{v={-0.8400,-0.9000, 1.5000},c=0},
		{v={ 0.0000,-0.9000, 1.5000},c=0},
		{v={ 0.7840,-0.9000, 1.4000},c=0},
		{v={ 1.4000,-0.9000, 0.7840},c=0},
		{v={ 0.7490,-1.0312, 1.3375},c=0},
		{v={ 1.3375,-1.0312, 0.7490},c=0},
		{v={ 0.8050,-1.0312, 1.4375},c=0},
		{v={ 1.4375,-1.0312, 0.8050},c=0},
		{v={ 0.8400,-0.9000, 1.5000},c=0},
		{v={ 1.5000,-0.9000, 0.8400},c=0},
		{v={ 1.7500,-0.3750, 0.0000},c=0},
		{v={ 1.7500,-0.3750,-0.9800},c=0},
		{v={ 0.9800,-0.3750,-1.7500},c=0},
		{v={ 0.0000,-0.3750,-1.7500},c=0},
		{v={ 2.0000,0.1500, 0.0000},c=0},
		{v={ 2.0000,0.1500,-1.1200},c=0},
		{v={ 1.1200,0.1500,-2.0000},c=0},
		{v={ 0.0000,0.1500,-2.0000},c=0},
		{v={ 2.0000,0.6000, 0.0000},c=0},
		{v={ 2.0000,0.6000,-1.1200},c=0},
		{v={ 1.1200,0.6000,-2.0000},c=0},
		{v={ 0.0000,0.6000,-2.0000},c=0},
		{v={-0.9800,-0.3750,-1.7500},c=0},
		{v={-1.7500,-0.3750,-0.9800},c=0},
		{v={-1.7500,-0.3750, 0.0000},c=0},
		{v={-1.1200,0.1500,-2.0000},c=0},
		{v={-2.0000,0.1500,-1.1200},c=0},
		{v={-2.0000,0.1500, 0.0000},c=0},
		{v={-1.1200,0.6000,-2.0000},c=0},
		{v={-2.0000,0.6000,-1.1200},c=0},
		{v={-2.0000,0.6000, 0.0000},c=0},
		{v={-1.7500,-0.3750, 0.9800},c=0},
		{v={-0.9800,-0.3750, 1.7500},c=0},
		{v={ 0.0000,-0.3750, 1.7500},c=0},
		{v={-2.0000,0.1500, 1.1200},c=0},
		{v={-1.1200,0.1500, 2.0000},c=0},
		{v={ 0.0000,0.1500, 2.0000},c=0},
		{v={-2.0000,0.6000, 1.1200},c=0},
		{v={-1.1200,0.6000, 2.0000},c=0},
		{v={ 0.0000,0.6000, 2.0000},c=0},
		{v={ 0.9800,-0.3750, 1.7500},c=0},
		{v={ 1.7500,-0.3750, 0.9800},c=0},
		{v={ 1.1200,0.1500, 2.0000},c=0},
		{v={ 2.0000,0.1500, 1.1200},c=0},
		{v={ 1.1200,0.6000, 2.0000},c=0},
		{v={ 2.0000,0.6000, 1.1200},c=0},
		{v={ 2.0000,1.0500, 0.0000},c=0},
		{v={ 2.0000,1.0500,-1.1200},c=0},
		{v={ 1.1200,1.0500,-2.0000},c=0},
		{v={ 0.0000,1.0500,-2.0000},c=0},
		{v={ 1.5000,1.2750, 0.0000},c=0},
		{v={ 1.5000,1.2750,-0.8400},c=0},
		{v={ 0.8400,1.2750,-1.5000},c=0},
		{v={ 0.0000,1.2750,-1.5000},c=0},
		{v={ 1.5000,1.3500, 0.0000},c=0},
		{v={ 1.5000,1.3500,-0.8400},c=0},
		{v={ 0.8400,1.3500,-1.5000},c=0},
		{v={ 0.0000,1.3500,-1.5000},c=0},
		{v={-1.1200,1.0500,-2.0000},c=0},
		{v={-2.0000,1.0500,-1.1200},c=0},
		{v={-2.0000,1.0500, 0.0000},c=0},
		{v={-0.8400,1.2750,-1.5000},c=0},
		{v={-1.5000,1.2750,-0.8400},c=0},
		{v={-1.5000,1.2750, 0.0000},c=0},
		{v={-0.8400,1.3500,-1.5000},c=0},
		{v={-1.5000,1.3500,-0.8400},c=0},
		{v={-1.5000,1.3500, 0.0000},c=0},
		{v={-2.0000,1.0500, 1.1200},c=0},
		{v={-1.1200,1.0500, 2.0000},c=0},
		{v={ 0.0000,1.0500, 2.0000},c=0},
		{v={-1.5000,1.2750, 0.8400},c=0},
		{v={-0.8400,1.2750, 1.5000},c=0},
		{v={ 0.0000,1.2750, 1.5000},c=0},
		{v={-1.5000,1.3500, 0.8400},c=0},
		{v={-0.8400,1.3500, 1.5000},c=0},
		{v={ 0.0000,1.3500, 1.5000},c=0},
		{v={ 1.1200,1.0500, 2.0000},c=0},
		{v={ 2.0000,1.0500, 1.1200},c=0},
		{v={ 0.8400,1.2750, 1.5000},c=0},
		{v={ 1.5000,1.2750, 0.8400},c=0},
		{v={ 0.8400,1.3500, 1.5000},c=0},
		{v={ 1.5000,1.3500, 0.8400},c=0},
		{v={-1.6000,-0.5250, 0.0000},c=0},
		{v={-1.6000,-0.5250,-0.3000},c=0},
		{v={-1.5000,-0.7500,-0.3000},c=0},
		{v={-1.5000,-0.7500, 0.0000},c=0},
		{v={-2.3000,-0.5250, 0.0000},c=0},
		{v={-2.3000,-0.5250,-0.3000},c=0},
		{v={-2.5000,-0.7500,-0.3000},c=0},
		{v={-2.5000,-0.7500, 0.0000},c=0},
		{v={-2.7000,-0.5250, 0.0000},c=0},
		{v={-2.7000,-0.5250,-0.3000},c=0},
		{v={-3.0000,-0.7500,-0.3000},c=0},
		{v={-3.0000,-0.7500, 0.0000},c=0},
		{v={-2.7000,-0.3000, 0.0000},c=0},
		{v={-2.7000,-0.3000,-0.3000},c=0},
		{v={-3.0000,-0.3000,-0.3000},c=0},
		{v={-3.0000,-0.3000, 0.0000},c=0},
		{v={-1.5000,-0.7500, 0.3000},c=0},
		{v={-1.6000,-0.5250, 0.3000},c=0},
		{v={-2.5000,-0.7500, 0.3000},c=0},
		{v={-2.3000,-0.5250, 0.3000},c=0},
		{v={-3.0000,-0.7500, 0.3000},c=0},
		{v={-2.7000,-0.5250, 0.3000},c=0},
		{v={-3.0000,-0.3000, 0.3000},c=0},
		{v={-2.7000,-0.3000, 0.3000},c=0},
		{v={-2.7000,-0.0750, 0.0000},c=0},
		{v={-2.7000,-0.0750,-0.3000},c=0},
		{v={-3.0000,0.1500,-0.3000},c=0},
		{v={-3.0000,0.1500, 0.0000},c=0},
		{v={-2.5000,0.3750, 0.0000},c=0},
		{v={-2.5000,0.3750,-0.3000},c=0},
		{v={-2.6500,0.5625,-0.3000},c=0},
		{v={-2.6500,0.5625, 0.0000},c=0},
		{v={-2.0000,0.6000,-0.3000},c=0},
		{v={-1.9000,0.9000,-0.3000},c=0},
		{v={-1.9000,0.9000, 0.0000},c=0},
		{v={-3.0000,0.1500, 0.3000},c=0},
		{v={-2.7000,-0.0750, 0.3000},c=0},
		{v={-2.6500,0.5625, 0.3000},c=0},
		{v={-2.5000,0.3750, 0.3000},c=0},
		{v={-1.9000,0.9000, 0.3000},c=0},
		{v={-2.0000,0.6000, 0.3000},c=0},
		{v={ 1.7000,0.0750, 0.0000},c=0},
		{v={ 1.7000,0.0750,-0.6600},c=0},
		{v={ 1.7000,0.9000,-0.6600},c=0},
		{v={ 1.7000,0.9000, 0.0000},c=0},
		{v={ 2.6000,0.0750, 0.0000},c=0},
		{v={ 2.6000,0.0750,-0.6600},c=0},
		{v={ 3.1000,0.6750,-0.6600},c=0},
		{v={ 3.1000,0.6750, 0.0000},c=0},
		{v={ 2.3000,-0.6000, 0.0000},c=0},
		{v={ 2.3000,-0.6000,-0.2500},c=0},
		{v={ 2.4000,-0.5250,-0.2500},c=0},
		{v={ 2.4000,-0.5250, 0.0000},c=0},
		{v={ 2.7000,-0.9000, 0.0000},c=0},
		{v={ 2.7000,-0.9000,-0.2500},c=0},
		{v={ 3.3000,-0.9000,-0.2500},c=0},
		{v={ 3.3000,-0.9000, 0.0000},c=0},
		{v={ 1.7000,0.9000, 0.6600},c=0},
		{v={ 1.7000,0.0750, 0.6600},c=0},
		{v={ 3.1000,0.6750, 0.6600},c=0},
		{v={ 2.6000,0.0750, 0.6600},c=0},
		{v={ 2.4000,-0.5250, 0.2500},c=0},
		{v={ 2.3000,-0.6000, 0.2500},c=0},
		{v={ 3.3000,-0.9000, 0.2500},c=0},
		{v={ 2.7000,-0.9000, 0.2500},c=0},
		{v={ 2.8000,-0.9750, 0.0000},c=0},
		{v={ 2.8000,-0.9750,-0.2500},c=0},
		{v={ 3.5250,-0.9937,-0.2500},c=0},
		{v={ 3.5250,-0.9937, 0.0000},c=0},
		{v={ 2.9000,-0.9750, 0.0000},c=0},
		{v={ 2.9000,-0.9750,-0.1500},c=0},
		{v={ 3.4500,-1.0125,-0.1500},c=0},
		{v={ 3.4500,-1.0125, 0.0000},c=0},
		{v={ 2.8000,-0.9000, 0.0000},c=0},
		{v={ 2.8000,-0.9000,-0.1500},c=0},
		{v={ 3.2000,-0.9000,-0.1500},c=0},
		{v={ 3.2000,-0.9000, 0.0000},c=0},
		{v={ 3.5250,-0.9937, 0.2500},c=0},
		{v={ 2.8000,-0.9750, 0.2500},c=0},
		{v={ 3.4500,-1.0125, 0.1500},c=0},
		{v={ 2.9000,-0.9750, 0.1500},c=0},
		{v={ 3.2000,-0.9000, 0.1500},c=0},
		{v={ 2.8000,-0.9000, 0.1500},c=0},
		{v={ 0.0000,-1.6500, 0.0000},c=0},
		{v={ 0.0000,-1.6500,-0.0020},c=0},
		{v={ 0.0020,-1.6500, 0.0000},c=0},
		{v={ 0.8000,-1.6500, 0.0000},c=0},
		{v={ 0.8000,-1.6500,-0.4500},c=0},
		{v={ 0.4500,-1.6500,-0.8000},c=0},
		{v={ 0.0000,-1.6500,-0.8000},c=0},
		{v={ 0.0000,-1.3500, 0.0000},c=0},
		{v={ 0.2000,-1.2000, 0.0000},c=0},
		{v={ 0.2000,-1.2000,-0.1120},c=0},
		{v={ 0.1120,-1.2000,-0.2000},c=0},
		{v={ 0.0000,-1.2000,-0.2000},c=0},
		{v={-0.0020,-1.6500, 0.0000},c=0},
		{v={-0.4500,-1.6500,-0.8000},c=0},
		{v={-0.8000,-1.6500,-0.4500},c=0},
		{v={-0.8000,-1.6500, 0.0000},c=0},
		{v={-0.1120,-1.2000,-0.2000},c=0},
		{v={-0.2000,-1.2000,-0.1120},c=0},
		{v={-0.2000,-1.2000, 0.0000},c=0},
		{v={ 0.0000,-1.6500, 0.0020},c=0},
		{v={-0.8000,-1.6500, 0.4500},c=0},
		{v={-0.4500,-1.6500, 0.8000},c=0},
		{v={ 0.0000,-1.6500, 0.8000},c=0},
		{v={-0.2000,-1.2000, 0.1120},c=0},
		{v={-0.1120,-1.2000, 0.2000},c=0},
		{v={ 0.0000,-1.2000, 0.2000},c=0},
		{v={ 0.4500,-1.6500, 0.8000},c=0},
		{v={ 0.8000,-1.6500, 0.4500},c=0},
		{v={ 0.1120,-1.2000, 0.2000},c=0},
		{v={ 0.2000,-1.2000, 0.1120},c=0},
		{v={ 0.4000,-1.0500, 0.0000},c=0},
		{v={ 0.4000,-1.0500,-0.2240},c=0},
		{v={ 0.2240,-1.0500,-0.4000},c=0},
		{v={ 0.0000,-1.0500,-0.4000},c=0},
		{v={ 1.3000,-1.0500, 0.0000},c=0},
		{v={ 1.3000,-1.0500,-0.7280},c=0},
		{v={ 0.7280,-1.0500,-1.3000},c=0},
		{v={ 0.0000,-1.0500,-1.3000},c=0},
		{v={ 1.3000,-0.9000, 0.0000},c=0},
		{v={ 1.3000,-0.9000,-0.7280},c=0},
		{v={ 0.7280,-0.9000,-1.3000},c=0},
		{v={ 0.0000,-0.9000,-1.3000},c=0},
		{v={-0.2240,-1.0500,-0.4000},c=0},
		{v={-0.4000,-1.0500,-0.2240},c=0},
		{v={-0.4000,-1.0500, 0.0000},c=0},
		{v={-0.7280,-1.0500,-1.3000},c=0},
		{v={-1.3000,-1.0500,-0.7280},c=0},
		{v={-1.3000,-1.0500, 0.0000},c=0},
		{v={-0.7280,-0.9000,-1.3000},c=0},
		{v={-1.3000,-0.9000,-0.7280},c=0},
		{v={-1.3000,-0.9000, 0.0000},c=0},
		{v={-0.4000,-1.0500, 0.2240},c=0},
		{v={-0.2240,-1.0500, 0.4000},c=0},
		{v={ 0.0000,-1.0500, 0.4000},c=0},
		{v={-1.3000,-1.0500, 0.7280},c=0},
		{v={-0.7280,-1.0500, 1.3000},c=0},
		{v={ 0.0000,-1.0500, 1.3000},c=0},
		{v={-1.3000,-0.9000, 0.7280},c=0},
		{v={-0.7280,-0.9000, 1.3000},c=0},
		{v={ 0.0000,-0.9000, 1.3000},c=0},
		{v={ 0.2240,-1.0500, 0.4000},c=0},
		{v={ 0.4000,-1.0500, 0.2240},c=0},
		{v={ 0.7280,-1.0500, 1.3000},c=0},
		{v={ 1.3000,-1.0500, 0.7280},c=0},
		{v={ 0.7280,-0.9000, 1.3000},c=0},
		{v={ 1.3000,-0.9000, 0.7280},c=0},
		{v={ 0.0000,1.5000, 0.0000},c=0},
		{v={ 1.5000,1.3500, 0.0000},c=0},
		{v={ 1.5000,1.3500, 0.8400},c=0},
		{v={ 0.8400,1.3500, 1.5000},c=0},
		{v={ 0.0000,1.3500, 1.5000},c=0},
		{v={ 1.5000,1.4250, 0.0000},c=0},
		{v={ 1.5000,1.4250, 0.8400},c=0},
		{v={ 0.8400,1.4250, 1.5000},c=0},
		{v={ 0.0000,1.4250, 1.5000},c=0},
		{v={ 1.4250,1.5000, 0.0000},c=0},
		{v={ 1.4250,1.5000, 0.7980},c=0},
		{v={ 0.7980,1.5000, 1.4250},c=0},
		{v={ 0.0000,1.5000, 1.4250},c=0},
		{v={-0.8400,1.3500, 1.5000},c=0},
		{v={-1.5000,1.3500, 0.8400},c=0},
		{v={-1.5000,1.3500, 0.0000},c=0},
		{v={-0.8400,1.4250, 1.5000},c=0},
		{v={-1.5000,1.4250, 0.8400},c=0},
		{v={-1.5000,1.4250, 0.0000},c=0},
		{v={-0.7980,1.5000, 1.4250},c=0},
		{v={-1.4250,1.5000, 0.7980},c=0},
		{v={-1.4250,1.5000, 0.0000},c=0},
		{v={-1.5000,1.3500,-0.8400},c=0},
		{v={-0.8400,1.3500,-1.5000},c=0},
		{v={ 0.0000,1.3500,-1.5000},c=0},
		{v={-1.5000,1.4250,-0.8400},c=0},
		{v={-0.8400,1.4250,-1.5000},c=0},
		{v={ 0.0000,1.4250,-1.5000},c=0},
		{v={-1.4250,1.5000,-0.7980},c=0},
		{v={-0.7980,1.5000,-1.4250},c=0},
		{v={ 0.0000,1.5000,-1.4250},c=0},
		{v={ 0.8400,1.3500,-1.5000},c=0},
		{v={ 1.5000,1.3500,-0.8400},c=0},
		{v={ 0.8400,1.4250,-1.5000},c=0},
		{v={ 1.5000,1.4250,-0.8400},c=0},
		{v={ 0.7980,1.5000,-1.4250},c=0},
		{v={ 1.4250,1.5000,-0.7980},c=0}
	}
	for k,p in pairs(points) do
		p.c = abs(floor(p.v[1]+4))
		p.v = scale(20, p.v)
	end
end